name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create and copy project files
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 创建临时目录
          TEMP_DIR=$(mktemp -d)
          
          # 清理并准备目标目录
          rm -rf /opt/1panel/docker/compose/invoify/*
          mkdir -p /opt/1panel/docker/compose/invoify

          # 复制当前目录下所有文件到临时目录
          cp -r $GITHUB_WORKSPACE/* $TEMP_DIR/
          
          # 移动文件到目标目录
          mv $TEMP_DIR/* /opt/1panel/docker/compose/invoify/
          
          # 清理临时目录
          rm -rf $TEMP_DIR

          # 重启容器
          docker restart invoify

          # 等待容器完全启动
          sleep 5

          # 执行容器内的安装命令
          docker exec -i invoify /bin/bash << 'EOF'
            cd /app
            npm install
            apt-get update
            apt-get install -y \
              libnss3 \
              libglib2.0-0 \
              libatk1.0-0 \
              libcups2 \
              libdbus-1-3 \
              libexpat1 \
              libfontconfig1 \
              libgbm1 \
              libgtk-3-0 \
              libpango-1.0-0 \
              libx11-xcb1 \
              libxcomposite1 \
              libxdamage1 \
              libxkbcommon0 \
              libxrandr2 \
              libasound2
          EOF