name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 将项目文件同步到服务器指定目录
          rsync -avz --delete . /opt/1panel/docker/compose/

          # 重启"invoify" Docker容器
          docker restart invoify

          # 执行命令进入容器并安装必要软件包
          docker exec -i invoify /bin/bash << 'EOF'
            npm install
            apt-get update
            apt-get install -y \
              libnss3 \
              libglib2.0-0 \
              libatk1.0-0 \
              libcups2 \
              libdbus-1-3 \
              libexpat1 \
              libfontconfig1 \
              libgbm1 \
              libgtk-3-0 \
              libpango-1.0-0 \
              libx11-xcb1 \
              libxcomposite1 \
              libxdamage1 \
              libxkbcommon0 \
              libxrandr2 \
              libasound2
          EOF 